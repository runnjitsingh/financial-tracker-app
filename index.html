<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Financial Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel Standalone for in-browser JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Load React and ReactDOM UMD builds (makes React and ReactDOM globally available) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Load Firebase UMD builds (makes firebase globally available) -->
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>

    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font as per instructions */
        }
        /* Ensure all elements have rounded corners */
        .rounded-lg, .rounded-xl, .rounded-full {
            border-radius: 0.5rem; /* Tailwind default for rounded-lg */
        }
        /* Specific adjustments for input/select focus states */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8B5CF6; /* Purple-500 equivalent */
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.5); /* Purple-500 with opacity */
        }
        /* Responsive adjustments for tables on smaller screens */
        @media (max-width: 768px) {
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            }
            .min-w-full {
                width: 100%; /* Ensure table takes full width */
            }
            table th, table td {
                padding: 0.75rem 0.5rem; /* Adjust padding for smaller screens */
                font-size: 0.875rem; /* Smaller font size */
            }
        }
    </style>
</head>
<body>
    <!-- Trigger redeploy --> <!-- This comment helps ensure GitHub Pages redeploys -->
    <div id="root"></div> <!-- This is the main div where your React app will be rendered -->

    <script type="text/babel" data-presets="react">
        // Firebase modules are now globally available via the UMD scripts above.
        const firebaseConfig = {
            apiKey: "AIzaSyBXdNCah-x9Yltqh9HOFwi040icP5EMoGU",
            authDomain: "daily-expenses-report.firebaseapp.com",
            projectId: "daily-expenses-report",
            storageBucket: "daily-expenses-report.firebasestorage.app",
            messagingSenderId: "120648147969",
            appId: "1:120648147969:web:7f14b895866de16011d4c00",
            measurementId: "G-R6QJP29WCQ"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        console.log("Firebase initialized.");

        // --- Helper Functions ---
        // Helper function to format date for display
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const dateObj = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return dateObj.toLocaleDateString();
        };

        // Helper function to format date and time for full history
        const formatDateTime = (timestamp) => {
            if (!timestamp) return 'N/A';
            const dateObj = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return dateObj.toLocaleString();
        };

        // --- Reusable Components/Modules ---

        // Component for rendering a generic table with search and payment method filter
        function GenericTable({ data, columns, onDelete, onEdit, title, onBack, showAmounts, searchKeys }) {
            const [searchTerm, setSearchTerm] = React.useState('');
            const [filterMethod, setFilterMethod] = React.useState('All'); // 'All', 'Cash', 'KB', 'PNB'

            const paymentMethods = ['All', 'Cash', 'KB', 'PNB'];

            const filteredData = data.filter(item => {
                const matchesSearch = searchTerm.trim() === '' ||
                    searchKeys.some(key => {
                        const value = item[key];
                        return value != null && String(value).toLowerCase().includes(searchTerm.toLowerCase());
                    });
                const matchesMethod = filterMethod === 'All' || item.paymentMethod === filterMethod;
                return matchesSearch && matchesMethod;
            }).sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)); // Sort by newest first

            return (
                <div className="bg-white bg-opacity-90 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-5xl text-gray-800">
                    <button
                        onClick={onBack}
                        className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                    >
                        &larr; Back to Dashboard
                    </button>
                    <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center drop-shadow">
                        {title}
                    </h2>

                    <div className="flex flex-col sm:flex-row gap-4 mb-6">
                        <input
                            type="text"
                            placeholder="Search records..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="flex-grow px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500"
                        />
                        {columns.some(col => col.key === 'paymentMethod') && (
                            <select
                                value={filterMethod}
                                onChange={(e) => setFilterMethod(e.target.value)}
                                className="px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900"
                            >
                                {paymentMethods.map(method => (
                                    <option key={method} value={method}>{method === 'All' ? 'All Methods' : method}</option>
                                ))}
                            </select>
                        )}
                    </div>


                    {filteredData.length === 0 ? (
                        <p className="text-center text-gray-600">No records found for {title} matching your criteria.</p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full bg-gray-100 rounded-lg overflow-hidden border border-gray-300">
                                <thead className="bg-gray-200 text-left text-gray-700 uppercase text-sm leading-normal">
                                    <tr>
                                        {columns.map(col => (
                                            <th key={col.key} className={`py-3 px-4 ${col.align || 'text-left'}`}>
                                                {col.header}
                                            </th>
                                        ))}
                                        {(onDelete || onEdit) && <th className="py-3 px-4 text-center">Actions</th>}
                                    </tr>
                                </thead>
                                <tbody className="text-gray-700 text-sm font-light">
                                    {filteredData.map((item) => (
                                        <tr key={item.id} className="border-b border-gray-300 hover:bg-gray-200">
                                            {columns.map(col => (
                                                <td key={col.key} className={`py-3 px-4 ${col.align || 'text-left'}`}>
                                                    {col.key.includes('amount') || col.key.includes('cost') || col.key.includes('Lent') || col.key.includes('Returned') ?
                                                        (showAmounts ? (col.render ? col.render(item[col.key], item) : `‚Çπ${item[col.key].toFixed(2)}`) : '***')
                                                        : (col.render ? col.render(item[col.key], item) : item[col.key])
                                                    }
                                                </td>
                                            ))}
                                            {(onDelete || onEdit) && (
                                                <td className="py-3 px-4 text-center whitespace-nowrap">
                                                    {onEdit && (
                                                        <button
                                                            onClick={() => onEdit(item)}
                                                            className="text-blue-500 hover:text-blue-700 transition duration-200 mr-2"
                                                            aria-label={`Edit record ${item.id}`}
                                                        >
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                        </button>
                                                    )}
                                                    {onDelete && (
                                                        <button
                                                            onClick={() => onDelete(item.id, item.collectionName)}
                                                            className="text-red-500 hover:text-red-700 transition duration-200"
                                                            aria-label={`Delete record ${item.id}`}
                                                        >
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    )}
                                                </td>
                                            )}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }


        // --- Personal Transactions Module ---
        function PersonalTransactionsModule({ transactions, loading, onDeleteTransaction, onSaveTransaction, onBack, showAmounts, editingRecord, setEditingRecord }) {
            const [description, setDescription] = React.useState('');
            const [amount, setAmount] = React.useState(''); // Keep as string for input field
            const [type, setType] = React.useState('expense');
            const [date, setDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [paymentMethod, setPaymentMethod] = React.useState('Cash');

            const paymentMethods = ['Cash', 'KB', 'PNB'];
            // Populate form if editingRecord changes or reset if it becomes null
            React.useEffect(() => {
                console.log("[PersonalTransactionsModule] useEffect triggered. editingRecord:", editingRecord);
                if (editingRecord) {
                    setDescription(editingRecord.description || '');
                    setAmount(String(editingRecord.amount || '')); // Convert number to string for input
                    setType(editingRecord.type || 'expense');
                    setDate(editingRecord.date || new Date().toISOString().split('T')[0]);
                    setPaymentMethod(editingRecord.paymentMethod || 'Cash');
                } else {
                    // Reset form when not editing (i.e., when editingRecord is null)
                    setDescription('');
                    setAmount('');
                    setType('expense');
                    setDate(new Date().toISOString().split('T')[0]);
                    setPaymentMethod('Cash');
                }
            }, [editingRecord]); // Dependency on editingRecord

            const handleSave = async (e) => {
                e.preventDefault();
                if (!description.trim() || !amount || !date || !paymentMethod) {
                    console.error('Validation Error: Please fill in all fields (Description, Amount, Date, Payment Method).');
                    return;
                }
                let numAmount = parseFloat(amount);
                if (isNaN(numAmount) || numAmount <= 0) {
                    console.error('Validation Error: Please enter a valid positive number for the amount.');
                    return;
                }
                numAmount = parseFloat(numAmount.toFixed(2)); // Ensure 2 decimal places for storage

                const dataToSave = {
                    description: description.trim(),
                    amount: numAmount,
                    type,
                    date,
                    paymentMethod,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    collectionName: 'personal_transactions'
                };

                await onSaveTransaction(editingRecord ? { ...dataToSave, id: editingRecord.id } : dataToSave, 'personal_transactions');
            };

            const personalTransactionColumns = [
                { key: 'date', header: 'Date', align: 'text-left' },
                { key: 'description', header: 'Description', align: 'text-left' },
                { key: 'type', header: 'Type', align: 'text-left', render: (value) => <span className={`font-semibold ${value === 'expense' ? 'text-red-500' : 'text-green-500'}`}>{value === 'expense' ? 'Expense' : 'Income'}</span> },
                { key: 'amount', header: 'Amount', align: 'text-right', render: (value) => `‚Çπ${value.toFixed(2)}` },
                { key: 'paymentMethod', header: 'Method', align: 'text-left' },
            ];

            const personalSearchKeys = ['description', 'paymentMethod', 'date', 'type'];


            return (
                <div className="bg-white bg-opacity-90 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-5xl text-gray-800">
                    <button
                        onClick={onBack}
                        className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                    >
                        &larr; Back to Dashboard
                    </button>
                    <h2 className="text-3xl font-bold text-gray-800 mb-8 text-center drop-shadow">
                        üí∞ Personal Transactions
                    </h2>

                    <form onSubmit={handleSave} className="space-y-4 mb-8">
                        <div>
                            <label htmlFor="description" className="block text-sm font-medium text-gray-700">Description</label>
                            <input
                                type="text"
                                id="description"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                placeholder="Groceries, Salary, Rent..."
                                className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="amount" className="block text-sm font-medium text-gray-700">Amount</label>
                            <input
                                type="number"
                                id="amount"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                placeholder="e.g., 50.00"
                                step="0.01"
                                className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="date" className="block text-sm font-medium text-gray-700">Date</label>
                            <input
                                type="date"
                                id="date"
                                value={date}
                                onChange={(e) => setDate(e.target.value)}
                                className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="paymentMethod" className="block text-sm font-medium text-gray-700">Payment Method</label>
                            <select
                                id="paymentMethod"
                                value={paymentMethod}
                                onChange={(e) => setPaymentMethod(e.target.value)}
                                className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900"
                                required
                            >
                                {paymentMethods.map(method => (
                                    <option key={method} value={method}>{method}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex items-center space-x-4">
                            <label className="flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input
                                    type="radio"
                                    name="type"
                                    value="expense"
                                    checked={type === 'expense'}
                                    onChange={() => setType('expense')}
                                    className="form-radio text-red-500 h-4 w-4"
                                />
                                <span className="ml-2">Expense</span>
                            </label>
                            <label className="flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input
                                    type="radio"
                                    name="type"
                                    value="income"
                                    checked={type === 'income'}
                                    onChange={() => setType('income')}
                                    className="form-radio text-green-500 h-4 w-4"
                                />
                                <span className="ml-2">Income</span>
                            </label>
                        </div>
                        <button
                            type="submit"
                            className="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                        >
                            {editingRecord ? 'Update Transaction' : 'Add Transaction'}
                        </button>
                        {editingRecord && (
                            <button
                                type="button"
                                onClick={() => setEditingRecord(null)} // This will clear editingRecord and trigger useEffect to reset form
                                className="w-full bg-gray-400 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                            >
                                Cancel Edit
                            </button>
                        )}
                    </form>

                    <h3 className="text-xl font-bold text-gray-700 mb-4 text-center">Personal Transaction History</h3>
                    {loading ? (
                        <p className="text-center text-gray-600">Loading personal transactions...</p>
                    ) : (
                        <GenericTable
                            data={transactions}
                            columns={personalTransactionColumns}
                            onDelete={onDeleteTransaction}
                            onEdit={setEditingRecord}
                            title="Personal Transaction Records"
                            onBack={onBack}
                            showAmounts={showAmounts}
                            searchKeys={personalSearchKeys}
                        />
                    )}
                </div>
            );
        }

        // --- Truck Repairing Module ---
        function TruckRepairModule({ repairs, loading, onDeleteRepair, onSaveRepair, onBack, showAmounts, editingRecord, setEditingRecord }) {
            const [vehicleId, setVehicleId] = React.useState('');
            const [customerName, setCustomerName] = React.useState('');
            const [repairDescription, setRepairDescription] = React.useState('');
            const [cost, setCost] = React.useState('');
            const [date, setDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [paymentMethod, setPaymentMethod] = React.useState('Cash');

            const paymentMethods = ['Cash', 'KB', 'PNB'];

            React.useEffect(() => {
                console.log("[TruckRepairModule] useEffect triggered. editingRecord:", editingRecord);
                if (editingRecord) {
                    setVehicleId(editingRecord.vehicleId || '');
                    setCustomerName(editingRecord.customerName || '');
                    setRepairDescription(editingRecord.repairDescription || '');
                    setCost(String(editingRecord.cost || ''));
                    setDate(editingRecord.date || new Date().toISOString().split('T')[0]);
                    setPaymentMethod(editingRecord.paymentMethod || 'Cash');
                } else {
                    setVehicleId('');
                    setCustomerName('');
                    setRepairDescription('');
                    setCost('');
                    setDate(new Date().toISOString().split('T')[0]);
                    setPaymentMethod('Cash');
                }
            }, [editingRecord]);

            const handleSave = async (e) => {
                e.preventDefault();
                if (!vehicleId.trim() || !customerName.trim() || !repairDescription.trim() || !cost || !date || !paymentMethod) {
                    console.error('Validation Error: Please fill in all fields for Truck Repair.');
                    return;
                }
                let numCost = parseFloat(cost);
                if (isNaN(numCost) || numCost <= 0) {
                    console.error('Validation Error: Please enter a valid positive number for the cost.');
                    return;
                }
                numCost = parseFloat(numCost.toFixed(2));

                const dataToSave = {
                    vehicleId: vehicleId.trim(),
                    customerName: customerName.trim(),
                    repairDescription: repairDescription.trim(),
                    cost: numCost,
                    date,
                    paymentMethod,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    collectionName: 'truck_repairs'
                };

                await onSaveRepair(editingRecord ? { ...dataToSave, id: editingRecord.id } : dataToSave, 'truck_repairs');
            };

            const totalRepairRevenue = repairs.reduce((sum, r) => sum + r.cost, 0).toFixed(2);

            const truckRepairColumns = [
                { key: 'date', header: 'Date', align: 'text-left' },
                { key: 'vehicleId', header: 'Vehicle ID', align: 'text-left' },
                { key: 'customerName', header: 'Customer', align: 'text-left' },
                { key: 'repairDescription', header: 'Description', align: 'text-left' },
                { key: 'cost', header: 'Cost', align: 'text-right', render: (value) => `‚Çπ${value.toFixed(2)}` },
                { key: 'paymentMethod', header: 'Method', align: 'text-left' },
            ];

            const truckRepairSearchKeys = ['vehicleId', 'customerName', 'repairDescription', 'paymentMethod', 'date'];

            return (
                <div className="bg-white bg-opacity-90 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-5xl text-gray-800">
                    <button
                        onClick={onBack}
                        className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                    >
                        &larr; Back to Dashboard
                    </button>
                    <h2 className="text-3xl font-bold text-gray-800 mb-8 text-center drop-shadow">
                        üöö Truck Repair Management
                    </h2>

                    <form onSubmit={handleSave} className="space-y-4 mb-8">
                        <div>
                            <label htmlFor="vehicleId" className="block text-sm font-medium text-gray-700">Vehicle ID</label>
                            <input type="text" id="vehicleId" value={vehicleId} onChange={(e) => setVehicleId(e.target.value)} placeholder="TRK-1234" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="customerName" className="block text-sm font-medium text-gray-700">Customer Name</label>
                            <input type="text" id="customerName" value={customerName} onChange={(e) => setCustomerName(e.target.value)} placeholder="John Doe" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="repairDescription" className="block text-sm font-medium text-gray-700">Repair Description</label>
                            <textarea id="repairDescription" value={repairDescription} onChange={(e) => setRepairDescription(e.target.value)} placeholder="Engine overhaul, Tire replacement..." rows="3" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required></textarea>
                        </div>
                        <div>
                            <label htmlFor="cost" className="block text-sm font-medium text-gray-700">Cost</label>
                            <input type="number" id="cost" value={cost} onChange={(e) => setCost(e.target.value)} placeholder="e.g., 5000.00" step="0.01" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="repairDate" className="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="repairDate" value={date} onChange={(e) => setDate(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="repairPaymentMethod" className="block text-sm font-medium text-gray-700">Payment Method</label>
                            <select id="repairPaymentMethod" value={paymentMethod} onChange={(e) => setPaymentMethod(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900" required>
                                {paymentMethods.map(method => (
                                    <option key={method} value={method}>{method}</option>
                                ))}
                            </select>
                        </div>
                        <button type="submit" className="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                            {editingRecord ? 'Update Repair' : 'Add Repair Record'}
                        </button>
                        {editingRecord && (
                            <button
                                type="button"
                                onClick={() => setEditingRecord(null)}
                                className="w-full bg-gray-400 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                            >
                                Cancel Edit
                            </button>
                        )}
                    </form>

                    <div className="bg-blue-100 rounded-lg p-3 text-center mb-8">
                        <h3 className="text-lg font-semibold text-blue-700">Total Repair Revenue</h3>
                        <p className="text-3xl font-bold text-blue-600">{showAmounts ? `‚Çπ${totalRepairRevenue}` : '***'}</p>
                    </div>

                    <h3 className="text-xl font-bold text-gray-700 mb-4 text-center">Repair History</h3>
                    {loading ? (
                        <p className="text-center text-gray-600">Loading repair records...</p>
                    ) : (
                        <GenericTable
                            data={repairs}
                            columns={truckRepairColumns}
                            onDelete={onDeleteRepair}
                            onEdit={setEditingRecord}
                            title="Truck Repair Records"
                            onBack={onBack}
                            showAmounts={showAmounts}
                            searchKeys={truckRepairSearchKeys}
                        />
                    )}
                </div>
            );
        }

        // --- Rent Collection Module ---
        function RentCollectionModule({ rents, loading, onDeleteRent, onSaveRent, onBack, showAmounts, editingRecord, setEditingRecord }) {
            const [propertyAddress, setPropertyAddress] = React.useState('');
            const [tenantName, setTenantName] = React.useState('');
            const [amount, setAmount] = React.useState('');
            const [date, setDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [paymentMethod, setPaymentMethod] = React.useState('Cash');

            const paymentMethods = ['Cash', 'KB', 'PNB'];

            React.useEffect(() => {
                console.log("[RentCollectionModule] useEffect triggered. editingRecord:", editingRecord);
                if (editingRecord) {
                    setPropertyAddress(editingRecord.propertyAddress || '');
                    setTenantName(editingRecord.tenantName || '');
                    setAmount(String(editingRecord.amount || ''));
                    setDate(editingRecord.date || new Date().toISOString().split('T')[0]);
                    setPaymentMethod(editingRecord.paymentMethod || 'Cash');
                } else {
                    setPropertyAddress('');
                    setTenantName('');
                    setAmount('');
                    setDate(new Date().toISOString().split('T')[0]);
                    setPaymentMethod('Cash');
                }
            }, [editingRecord]);

            const handleSave = async (e) => {
                e.preventDefault();
                if (!propertyAddress.trim() || !tenantName.trim() || !amount || !date || !paymentMethod) {
                    console.error('Validation Error: Please fill in all fields for Rent Collection.');
                    return;
                }
                let numAmount = parseFloat(amount);
                if (isNaN(numAmount) || numAmount <= 0) {
                    console.error('Validation Error: Please enter a valid positive number for the amount.');
                    return;
                }
                numAmount = parseFloat(numAmount.toFixed(2));

                const dataToSave = {
                    propertyAddress: propertyAddress.trim(),
                    tenantName: tenantName.trim(),
                    amount: numAmount,
                    date,
                    paymentMethod,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    collectionName: 'rent_collections'
                };

                await onSaveRent(editingRecord ? { ...dataToSave, id: editingRecord.id } : dataToSave, 'rent_collections');
            };

            const totalRentCollected = rents.reduce((sum, r) => sum + r.amount, 0).toFixed(2);

            const rentColumns = [
                { key: 'date', header: 'Date', align: 'text-left' },
                { key: 'propertyAddress', header: 'Property', align: 'text-left' },
                { key: 'tenantName', header: 'Tenant', align: 'text-left' },
                { key: 'amount', header: 'Amount', align: 'text-right', render: (value) => `‚Çπ${value.toFixed(2)}` },
                { key: 'paymentMethod', header: 'Method', align: 'text-left' },
            ];

            const rentSearchKeys = ['propertyAddress', 'tenantName', 'paymentMethod', 'date'];

            return (
                <div className="bg-white bg-opacity-90 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-5xl text-gray-800">
                    <button
                        onClick={onBack}
                        className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                    >
                        &larr; Back to Dashboard
                    </button>
                    <h2 className="text-3xl font-bold text-gray-800 mb-8 text-center drop-shadow">
                        üè† Rent Collection
                    </h2>

                    <form onSubmit={handleSave} className="space-y-4 mb-8">
                        <div>
                            <label htmlFor="propertyAddress" className="block text-sm font-medium text-gray-700">Property Address</label>
                            <input type="text" id="propertyAddress" value={propertyAddress} onChange={(e) => setPropertyAddress(e.target.value)} placeholder="123 Main St" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="tenantName" className="block text-sm font-medium text-gray-700">Tenant Name</label>
                            <input type="text" id="tenantName" value={tenantName} onChange={(e) => setTenantName(e.target.value)} placeholder="Jane Doe" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="rentAmount" className="block text-sm font-medium text-gray-700">Amount</label>
                            <input type="number" id="rentAmount" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="e.g., 15000.00" step="0.01" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="rentDate" className="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="rentDate" value={date} onChange={(e) => setDate(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="rentPaymentMethod" className="block text-sm font-medium text-gray-700">Payment Method</label>
                            <select id="rentPaymentMethod" value={paymentMethod} onChange={(e) => setPaymentMethod(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900" required>
                                {paymentMethods.map(method => (
                                    <option key={method} value={method}>{method}</option>
                                ))}
                            </select>
                        </div>
                        <button type="submit" className="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                            {editingRecord ? 'Update Rent Record' : 'Add Rent Record'}
                        </button>
                        {editingRecord && (
                            <button
                                type="button"
                                onClick={() => setEditingRecord(null)}
                                className="w-full bg-gray-400 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                            >
                                Cancel Edit
                            </button>
                        )}
                    </form>

                    <div className="bg-blue-100 rounded-lg p-3 text-center mb-8">
                        <h3 className="text-lg font-semibold text-blue-700">Total Rent Collected</h3>
                        <p className="text-3xl font-bold text-blue-600">{showAmounts ? `‚Çπ${totalRentCollected}` : '***'}</p>
                    </div>

                    <h3 className="text-xl font-bold text-gray-700 mb-4 text-center">Rent History</h3>
                    {loading ? (
                        <p className="text-center text-gray-600">Loading rent records...</p>
                    ) : (
                        <GenericTable
                            data={rents}
                            columns={rentColumns}
                            onDelete={onDeleteRent}
                            onEdit={setEditingRecord}
                            title="Rent Records"
                            onBack={onBack}
                            showAmounts={showAmounts}
                            searchKeys={rentSearchKeys}
                        />
                    )}
                </div>
            );
        }

        // --- Main App Component ---
        // This is the main component that orchestrates all modules
        // and handles page navigation.
        function App() {
            const [currentPage, setCurrentPage] = React.useState('dashboard');
            const [showAmounts, setShowAmounts] = React.useState(true); // State for toggling amount visibility

            // State for Firebase data
            const [personalTransactions, setPersonalTransactions] = React.useState([]);
            const [truckRepairs, setTruckRepairs] = React.useState([]);
            const [rentCollections, setRentCollections] = React.useState([]);
            const [loanRecords, setLoanRecords] = React.useState([]);

            // Loading states for each collection
            const [loadingPersonal, setLoadingPersonal] = React.useState(true);
            const [loadingRepairs, setLoadingRepairs] = React.useState(true);
            const [loadingRents, setLoadingRents] = React.useState(true);
            const [loadingLoans, setLoadingLoans] = React.useState(true);

            // Editing states for each module
            const [editingPersonalRecord, setEditingPersonalRecord] = React.useState(null);
            const [editingRepairRecord, setEditingRepairRecord] = React.useState(null);
            const [editingRentRecord, setEditingRentRecord] = React.useState(null);
            const [editingLoanRecord, setEditingLoanRecord] = React.useState(null);


            // Fetch data from Firestore
            React.useEffect(() => {
                const unsubscribePersonal = db.collection('personal_transactions').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPersonalTransactions(data);
                    setLoadingPersonal(false);
                }, error => {
                    console.error("Error fetching personal transactions:", error);
                    setLoadingPersonal(false);
                });

                const unsubscribeRepairs = db.collection('truck_repairs').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTruckRepairs(data);
                    setLoadingRepairs(false);
                }, error => {
                    console.error("Error fetching truck repairs:", error);
                    setLoadingRepairs(false);
                });

                const unsubscribeRents = db.collection('rent_collections').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setRentCollections(data);
                    setLoadingRents(false);
                }, error => {
                    console.error("Error fetching rent collections:", error);
                    setLoadingRents(false);
                });

                const unsubscribeLoans = db.collection('loan_records').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setLoanRecords(data);
                    setLoadingLoans(false);
                }, error => {
                    console.error("Error fetching loan records:", error);
                    setLoadingLoans(false);
                });

                // Cleanup subscriptions on unmount
                return () => {
                    unsubscribePersonal();
                    unsubscribeRepairs();
                    unsubscribeRents();
                    unsubscribeLoans();
                };
            }, []);

            // CRUD Operations
            const handleSaveRecord = async (record, collectionName) => {
                try {
                    if (record.id) {
                        // Update existing record
                        const { id, collectionName: _, ...dataToUpdate } = record; // Destructure to remove id and collectionName
                        await db.collection(collectionName).doc(id).update(dataToUpdate);
                        console.log(`Record updated in ${collectionName}:`, id);
                        // Clear editing state for the respective module
                        if (collectionName === 'personal_transactions') setEditingPersonalRecord(null);
                        if (collectionName === 'truck_repairs') setEditingRepairRecord(null);
                        if (collectionName === 'rent_collections') setEditingRentRecord(null);
                        if (collectionName === 'loan_records') setEditingLoanRecord(null);
                    } else {
                        // Add new record
                        const { collectionName: _, ...dataToAdd } = record; // Destructure to remove collectionName
                        await db.collection(collectionName).add(dataToAdd);
                        console.log(`Record added to ${collectionName}.`);
                    }
                } catch (error) {
                    console.error(`Error saving record to ${collectionName}:`, error);
                }
            };

            const handleDeleteRecord = async (id, collectionName) => {
                try {
                    await db.collection(collectionName).doc(id).delete();
                    console.log(`Record deleted from ${collectionName}:`, id);
                } catch (error) {
                    console.error(`Error deleting record from ${collectionName}:`, error);
                }
            };

            // Calculate Totals for Dashboard
            const totalIncome = personalTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = personalTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const netBalance = totalIncome - totalExpenses;

            const totalRepairCost = truckRepairs.reduce((sum, r) => sum + r.cost, 0);
            const totalRentCollected = rentCollections.reduce((sum, r) => sum + r.amount, 0);
            const totalLoansGiven = loanRecords.filter(l => l.type === 'Lent').reduce((sum, l) => sum + l.amount, 0);
            const totalLoansReturned = loanRecords.filter(l => l.type === 'Returned').reduce((sum, l) => sum + l.amount, 0);
            const netLoans = totalLoansGiven - totalLoansReturned;


            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-500 to-indigo-700 flex flex-col items-center justify-center p-4 font-sans text-gray-900">
                    {currentPage === 'dashboard' && (
                        <div className="bg-white bg-opacity-90 rounded-xl shadow-2xl p-6 md:p-10 w-full max-w-4xl text-gray-800 text-center">
                            <h1 className="text-4xl font-extrabold text-purple-800 mb-6 drop-shadow-lg">
                                Financial Tracker Dashboard
                            </h1>

                            <div className="mb-6">
                                <button
                                    onClick={() => setShowAmounts(!showAmounts)}
                                    className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                                >
                                    {showAmounts ? 'Hide Amounts' : 'Show Amounts'}
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                <div className="bg-green-100 rounded-lg p-4 shadow-md flex flex-col items-center justify-center">
                                    <h3 className="text-lg font-semibold text-green-700">Total Income</h3>
                                    <p className="text-3xl font-bold text-green-600">{showAmounts ? `‚Çπ${totalIncome.toFixed(2)}` : '***'}</p>
                                </div>
                                <div className="bg-red-100 rounded-lg p-4 shadow-md flex flex-col items-center justify-center">
                                    <h3 className="text-lg font-semibold text-red-700">Total Expenses</h3>
                                    <p className="text-3xl font-bold text-red-600">{showAmounts ? `‚Çπ${totalExpenses.toFixed(2)}` : '***'}</p>
                                </div>
                                <div className={`rounded-lg p-4 shadow-md flex flex-col items-center justify-center ${netBalance >= 0 ? 'bg-blue-100' : 'bg-red-200'}`}>
                                    <h3 className="text-lg font-semibold text-blue-700">Net Balance</h3>
                                    <p className="text-3xl font-bold text-blue-600">{showAmounts ? `‚Çπ${netBalance.toFixed(2)}` : '***'}</p>
                                </div>
                                <div className="bg-yellow-100 rounded-lg p-4 shadow-md flex flex-col items-center justify-center">
                                    <h3 className="text-lg font-semibold text-yellow-700">Total Repair Revenue</h3>
                                    <p className="text-3xl font-bold text-yellow-600">{showAmounts ? `‚Çπ${totalRepairCost.toFixed(2)}` : '***'}</p>
                                </div>
                                <div className="bg-teal-100 rounded-lg p-4 shadow-md flex flex-col items-center justify-center">
                                    <h3 className="text-lg font-semibold text-teal-700">Total Rent Collected</h3>
                                    <p className="text-3xl font-bold text-teal-600">{showAmounts ? `‚Çπ${totalRentCollected.toFixed(2)}` : '***'}</p>
                                </div>
                                <div className={`rounded-lg p-4 shadow-md flex flex-col items-center justify-center ${netLoans <= 0 ? 'bg-green-100' : 'bg-red-200'}`}>
                                    <h3 className="text-lg font-semibold text-gray-700">Net Loans</h3>
                                    <p className="text-3xl font-bold text-gray-600">{showAmounts ? `‚Çπ${netLoans.toFixed(2)}` : '***'}</p>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <button
                                    onClick={() => setCurrentPage('personalTransactions')}
                                    className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md text-xl"
                                >
                                    Personal Transactions
                                </button>
                                <button
                                    onClick={() => setCurrentPage('truckRepair')}
                                    className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md text-xl"
                                >
                                    Truck Repair Management
                                </button>
                                <button
                                    onClick={() => setCurrentPage('rentCollection')}
                                    className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md text-xl"
                                >
                                    Rent Collection
                                </button>
                                <button
                                    onClick={() => setCurrentPage('loanRecords')}
                                    className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md text-xl"
                                >
                                    Loan Records
                                </button>
                            </div>
                        </div>
                    )}

                    {currentPage === 'personalTransactions' && (
                        <PersonalTransactionsModule
                            transactions={personalTransactions}
                            loading={loadingPersonal}
                            onDeleteTransaction={(id) => handleDeleteRecord(id, 'personal_transactions')}
                            onSaveTransaction={handleSaveRecord}
                            onBack={() => setCurrentPage('dashboard')}
                            showAmounts={showAmounts}
                            editingRecord={editingPersonalRecord}
                            setEditingRecord={setEditingPersonalRecord}
                        />
                    )}

                    {currentPage === 'truckRepair' && (
                        <TruckRepairModule
                            repairs={truckRepairs}
                            loading={loadingRepairs}
                            onDeleteRepair={(id) => handleDeleteRecord(id, 'truck_repairs')}
                            onSaveRepair={handleSaveRecord}
                            onBack={() => setCurrentPage('dashboard')}
                            showAmounts={showAmounts}
                            editingRecord={editingRepairRecord}
                            setEditingRecord={setEditingRepairRecord}
                        />
                    )}

                    {currentPage === 'rentCollection' && (
                        <RentCollectionModule
                            rents={rentCollections}
                            loading={loadingRents}
                            onDeleteRent={(id) => handleDeleteRecord(id, 'rent_collections')}
                            onSaveRent={handleSaveRecord}
                            onBack={() => setCurrentPage('dashboard')}
                            showAmounts={showAmounts}
                            editingRecord={editingRentRecord}
                            setEditingRecord={setEditingRentRecord}
                        />
                    )}

                    {currentPage === 'loanRecords' && (
                        <LoanRecordsModule
                            loans={loanRecords}
                            loading={loadingLoans}
                            onDeleteLoan={(id) => handleDeleteRecord(id, 'loan_records')}
                            onSaveLoan={handleSaveRecord}
                            onBack={() => setCurrentPage('dashboard')}
                            showAmounts={showAmounts}
                            editingRecord={editingLoanRecord}
                            setEditingRecord={setEditingLoanRecord}
                        />
                    )}
                </div>
            );
        }

        // This is the line that renders your main App component into the 'root' div.
        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
