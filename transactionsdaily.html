<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Financial Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel Standalone for in-browser JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Load React and ReactDOM UMD builds (makes React and ReactDOM globally available) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Load Firebase UMD builds (makes firebase globally available) -->
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>

    <script type="text/babel" data-presets="react">
        // Firebase modules are now globally available via the UMD scripts above.
        const firebaseConfig = {
            apiKey: "AIzaSyBXdNCah-x9Yltqh9HOFwi040icP5EMoGU",
            authDomain: "daily-expenses-report.firebaseapp.com",
            projectId: "daily-expenses-report",
            storageBucket: "daily-expenses-report.firebasestorage.app",
            messagingSenderId: "120648147969",
            appId: "1:120648147969:web:7f14b895866de16011d4c00",
            measurementId: "G-R6QJP29WCQ"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        console.log("Firebase initialized.");

        // --- Helper Functions ---
        // Helper function to format date for display
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const dateObj = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return dateObj.toLocaleDateString();
        };

        // Helper function to format date and time for full history
        const formatDateTime = (timestamp) => {
            if (!timestamp) return 'N/A';
            const dateObj = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return dateObj.toLocaleString();
        };

        // --- Reusable Components/Modules ---

        // Component for rendering a generic table with search and payment method filter
        function GenericTable({ data, columns, onDelete, onEdit, title, onBack, showAmounts, searchKeys }) {
            const [searchTerm, setSearchTerm] = React.useState('');
            const [filterMethod, setFilterMethod] = React.useState('All'); // 'All', 'Cash', 'KB', 'PNB'

            const paymentMethods = ['All', 'Cash', 'KB', 'PNB'];

            const filteredData = data.filter(item => {
                const matchesSearch = searchTerm.trim() === '' ||
                    searchKeys.some(key => {
                        const value = item[key];
                        return value != null && String(value).toLowerCase().includes(searchTerm.toLowerCase());
                    });
                const matchesMethod = filterMethod === 'All' || item.paymentMethod === filterMethod;
                return matchesSearch && matchesMethod;
            }).sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)); // Sort by newest first

            return (
                <div className="bg-white bg-opacity-90 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-5xl text-gray-800">
                    <button
                        onClick={onBack}
                        className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                    >
                        &larr; Back to Dashboard
                    </button>
                    <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center drop-shadow">
                        {title}
                    </h2>

                    <div className="flex flex-col sm:flex-row gap-4 mb-6">
                        <input
                            type="text"
                            placeholder="Search records..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="flex-grow px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500"
                        />
                        {columns.some(col => col.key === 'paymentMethod') && (
                            <select
                                value={filterMethod}
                                onChange={(e) => setFilterMethod(e.target.value)}
                                className="px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900"
                            >
                                {paymentMethods.map(method => (
                                    <option key={method} value={method}>{method === 'All' ? 'All Methods' : method}</option>
                                ))}
                            </select>
                        )}
                    </div>


                    {filteredData.length === 0 ? (
                        <p className="text-center text-gray-600">No records found for {title} matching your criteria.</p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full bg-gray-100 rounded-lg overflow-hidden border border-gray-300">
                                <thead className="bg-gray-200 text-left text-gray-700 uppercase text-sm leading-normal">
                                    <tr>
                                        {columns.map(col => (
                                            <th key={col.key} className={`py-3 px-4 ${col.align || 'text-left'}`}>
                                                {col.header}
                                            </th>
                                        ))}
                                        {(onDelete || onEdit) && <th className="py-3 px-4 text-center">Actions</th>}
                                    </tr>
                                </thead>
                                <tbody className="text-gray-700 text-sm font-light">
                                    {filteredData.map((item) => (
                                        <tr key={item.id} className="border-b border-gray-300 hover:bg-gray-200">
                                            {columns.map(col => (
                                                <td key={col.key} className={`py-3 px-4 ${col.align || 'text-left'}`}>
                                                    {col.key.includes('amount') || col.key.includes('cost') || col.key.includes('Lent') || col.key.includes('Returned') ?
                                                        (showAmounts ? (col.render ? col.render(item[col.key], item) : `₹${item[col.key].toFixed(2)}`) : '***')
                                                        : (col.render ? col.render(item[col.key], item) : item[col.key])
                                                    }
                                                </td>
                                            ))}
                                            {(onDelete || onEdit) && (
                                                <td className="py-3 px-4 text-center whitespace-nowrap">
                                                    {onEdit && (
                                                        <button
                                                            onClick={() => onEdit(item)}
                                                            className="text-blue-500 hover:text-blue-700 transition duration-200 mr-2"
                                                            aria-label={`Edit record ${item.id}`}
                                                        >
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                        </button>
                                                    )}
                                                    {onDelete && (
                                                        <button
                                                            onClick={() => onDelete(item.id, item.collectionName)}
                                                            className="text-red-500 hover:text-red-700 transition duration-200"
                                                            aria-label={`Delete record ${item.id}`}
                                                        >
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    )}
                                                </td>
                                            )}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }


        // --- Personal Transactions Module ---
        function PersonalTransactionsModule({ transactions, loading, onDeleteTransaction, onSaveTransaction, onBack, showAmounts, editingRecord, setEditingRecord }) {
            const [description, setDescription] = React.useState('');
            const [amount, setAmount] = React.useState(''); // Keep as string for input field
            const [type, setType] = React.useState('expense');
            const [date, setDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [paymentMethod, setPaymentMethod] = React.useState('Cash');

            const paymentMethods = ['Cash', 'KB', 'PNB'];

            // Populate form if editingRecord changes or reset if it becomes null
            React.useEffect(() => {
                console.log("[PersonalTransactionsModule] useEffect triggered. editingRecord:", editingRecord);
                if (editingRecord) {
                    setDescription(editingRecord.description || '');
                    setAmount(String(editingRecord.amount || '')); // Convert number to string for input
                    setType(editingRecord.type || 'expense');
                    setDate(editingRecord.date || new Date().toISOString().split('T')[0]);
                    setPaymentMethod(editingRecord.paymentMethod || 'Cash');
                } else {
                    // Reset form when not editing (i.e., when editingRecord is null)
                    setDescription('');
                    setAmount('');
                    setType('expense');
                    setDate(new Date().toISOString().split('T')[0]);
                    setPaymentMethod('Cash');
                }
            }, [editingRecord]); // Dependency on editingRecord

            const handleSave = async (e) => {
                e.preventDefault();
                if (!description.trim() || !amount || !date || !paymentMethod) {
                    console.error('Validation Error: Please fill in all fields (Description, Amount, Date, Payment Method).');
                    return;
                }
                let numAmount = parseFloat(amount);
                if (isNaN(numAmount) || numAmount <= 0) {
                    console.error('Validation Error: Please enter a valid positive number for the amount.');
                    return;
                }
                numAmount = parseFloat(numAmount.toFixed(2)); // Ensure 2 decimal places for storage

                const dataToSave = {
                    description: description.trim(),
                    amount: numAmount,
                    type,
                    date,
                    paymentMethod,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    collectionName: 'personal_transactions'
                };

                await onSaveTransaction(editingRecord ? { ...dataToSave, id: editingRecord.id } : dataToSave, 'personal_transactions');
            };

            const personalTransactionColumns = [
                { key: 'date', header: 'Date', align: 'text-left' },
                { key: 'description', header: 'Description', align: 'text-left' },
                { key: 'type', header: 'Type', align: 'text-left', render: (value) => <span className={`font-semibold ${value === 'expense' ? 'text-red-500' : 'text-green-500'}`}>{value === 'expense' ? 'Expense' : 'Income'}</span> },
                { key: 'amount', header: 'Amount', align: 'text-right', render: (value) => `₹${value.toFixed(2)}` },
                { key: 'paymentMethod', header: 'Method', align: 'text-left' },
            ];

            const personalSearchKeys = ['description', 'paymentMethod', 'date', 'type'];


            return (
                <div className="bg-white bg-opacity-90 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-5xl text-gray-800">
                    <button
                        onClick={onBack}
                        className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                    >
                        &larr; Back to Dashboard
                    </button>
                    <h2 className="text-3xl font-bold text-gray-800 mb-8 text-center drop-shadow">
                        💰 Personal Transactions
                    </h2>

                    <form onSubmit={handleSave} className="space-y-4 mb-8">
                        <div>
                            <label htmlFor="description" className="block text-sm font-medium text-gray-700">Description</label>
                            <input
                                type="text"
                                id="description"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                placeholder="Groceries, Salary, Rent..."
                                className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="amount" className="block text-sm font-medium text-gray-700">Amount</label>
                            <input
                                type="number"
                                id="amount"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                placeholder="e.g., 50.00"
                                step="0.01"
                                className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="date" className="block text-sm font-medium text-gray-700">Date</label>
                            <input
                                type="date"
                                id="date"
                                value={date}
                                onChange={(e) => setDate(e.target.value)}
                                className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="paymentMethod" className="block text-sm font-medium text-gray-700">Payment Method</label>
                            <select
                                id="paymentMethod"
                                value={paymentMethod}
                                onChange={(e) => setPaymentMethod(e.target.value)}
                                className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900"
                                required
                            >
                                {paymentMethods.map(method => (
                                    <option key={method} value={method}>{method}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex items-center space-x-4">
                            <label className="flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input
                                    type="radio"
                                    name="type"
                                    value="expense"
                                    checked={type === 'expense'}
                                    onChange={() => setType('expense')}
                                    className="form-radio text-red-500 h-4 w-4"
                                />
                                <span className="ml-2">Expense</span>
                            </label>
                            <label className="flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input
                                    type="radio"
                                    name="type"
                                    value="income"
                                    checked={type === 'income'}
                                    onChange={() => setType('income')}
                                    className="form-radio text-green-500 h-4 w-4"
                                />
                                <span className="ml-2">Income</span>
                            </label>
                        </div>
                        <button
                            type="submit"
                            className="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                        >
                            {editingRecord ? 'Update Transaction' : 'Add Transaction'}
                        </button>
                        {editingRecord && (
                            <button
                                type="button"
                                onClick={() => setEditingRecord(null)} // This will clear editingRecord and trigger useEffect to reset form
                                className="w-full bg-gray-400 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                            >
                                Cancel Edit
                            </button>
                        )}
                    </form>

                    <h3 className="text-xl font-bold text-gray-700 mb-4 text-center">Personal Transaction History</h3>
                    {loading ? (
                        <p className="text-center text-gray-600">Loading personal transactions...</p>
                    ) : (
                        <GenericTable
                            data={transactions}
                            columns={personalTransactionColumns}
                            onDelete={onDeleteTransaction}
                            onEdit={setEditingRecord}
                            title="Personal Transaction Records"
                            onBack={onBack}
                            showAmounts={showAmounts}
                            searchKeys={personalSearchKeys}
                        />
                    )}
                </div>
            );
        }

        // --- Truck Repairing Module ---
        function TruckRepairModule({ repairs, loading, onDeleteRepair, onSaveRepair, onBack, showAmounts, editingRecord, setEditingRecord }) {
            const [vehicleId, setVehicleId] = React.useState('');
            const [customerName, setCustomerName] = React.useState('');
            const [repairDescription, setRepairDescription] = React.useState('');
            const [cost, setCost] = React.useState('');
            const [date, setDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [paymentMethod, setPaymentMethod] = React.useState('Cash');

            const paymentMethods = ['Cash', 'KB', 'PNB'];

            React.useEffect(() => {
                console.log("[TruckRepairModule] useEffect triggered. editingRecord:", editingRecord);
                if (editingRecord) {
                    setVehicleId(editingRecord.vehicleId || '');
                    setCustomerName(editingRecord.customerName || '');
                    setRepairDescription(editingRecord.repairDescription || '');
                    setCost(String(editingRecord.cost || ''));
                    setDate(editingRecord.date || new Date().toISOString().split('T')[0]);
                    setPaymentMethod(editingRecord.paymentMethod || 'Cash');
                } else {
                    setVehicleId('');
                    setCustomerName('');
                    setRepairDescription('');
                    setCost('');
                    setDate(new Date().toISOString().split('T')[0]);
                    setPaymentMethod('Cash');
                }
            }, [editingRecord]);

            const handleSave = async (e) => {
                e.preventDefault();
                if (!vehicleId.trim() || !customerName.trim() || !repairDescription.trim() || !cost || !date || !paymentMethod) {
                    console.error('Validation Error: Please fill in all fields for Truck Repair.');
                    return;
                }
                let numCost = parseFloat(cost);
                if (isNaN(numCost) || numCost <= 0) {
                    console.error('Validation Error: Please enter a valid positive number for the cost.');
                    return;
                }
                numCost = parseFloat(numCost.toFixed(2));

                const dataToSave = {
                    vehicleId: vehicleId.trim(),
                    customerName: customerName.trim(),
                    repairDescription: repairDescription.trim(),
                    cost: numCost,
                    date,
                    paymentMethod,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    collectionName: 'truck_repairs'
                };

                await onSaveRepair(editingRecord ? { ...dataToSave, id: editingRecord.id } : dataToSave, 'truck_repairs');
            };

            const totalRepairRevenue = repairs.reduce((sum, r) => sum + r.cost, 0).toFixed(2);

            const truckRepairColumns = [
                { key: 'date', header: 'Date', align: 'text-left' },
                { key: 'vehicleId', header: 'Vehicle ID', align: 'text-left' },
                { key: 'customerName', header: 'Customer', align: 'text-left' },
                { key: 'repairDescription', header: 'Description', align: 'text-left' },
                { key: 'cost', header: 'Cost', align: 'text-right', render: (value) => `₹${value.toFixed(2)}` },
                { key: 'paymentMethod', header: 'Method', align: 'text-left' },
            ];

            const truckRepairSearchKeys = ['vehicleId', 'customerName', 'repairDescription', 'paymentMethod', 'date'];

            return (
                <div className="bg-white bg-opacity-90 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-5xl text-gray-800">
                    <button
                        onClick={onBack}
                        className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                    >
                        &larr; Back to Dashboard
                    </button>
                    <h2 className="text-3xl font-bold text-gray-800 mb-8 text-center drop-shadow">
                        🚚 Truck Repair Management
                    </h2>

                    <form onSubmit={handleSave} className="space-y-4 mb-8">
                        <div>
                            <label htmlFor="vehicleId" className="block text-sm font-medium text-gray-700">Vehicle ID</label>
                            <input type="text" id="vehicleId" value={vehicleId} onChange={(e) => setVehicleId(e.target.value)} placeholder="TRK-1234" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="customerName" className="block text-sm font-medium text-gray-700">Customer Name</label>
                            <input type="text" id="customerName" value={customerName} onChange={(e) => setCustomerName(e.target.value)} placeholder="John Doe" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="repairDescription" className="block text-sm font-medium text-gray-700">Repair Description</label>
                            <textarea id="repairDescription" value={repairDescription} onChange={(e) => setRepairDescription(e.target.value)} placeholder="Engine overhaul, Tire replacement..." rows="3" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required></textarea>
                        </div>
                        <div>
                            <label htmlFor="cost" className="block text-sm font-medium text-gray-700">Cost</label>
                            <input type="number" id="cost" value={cost} onChange={(e) => setCost(e.target.value)} placeholder="e.g., 5000.00" step="0.01" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="repairDate" className="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="repairDate" value={date} onChange={(e) => setDate(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="repairPaymentMethod" className="block text-sm font-medium text-gray-700">Payment Method</label>
                            <select id="repairPaymentMethod" value={paymentMethod} onChange={(e) => setPaymentMethod(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900" required>
                                {paymentMethods.map(method => (
                                    <option key={method} value={method}>{method}</option>
                                ))}
                            </select>
                        </div>
                        <button type="submit" className="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                            {editingRecord ? 'Update Repair' : 'Add Repair Record'}
                        </button>
                        {editingRecord && (
                            <button
                                type="button"
                                onClick={() => setEditingRecord(null)}
                                className="w-full bg-gray-400 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                            >
                                Cancel Edit
                            </button>
                        )}
                    </form>

                    <div className="bg-blue-100 rounded-lg p-3 text-center mb-8">
                        <h3 className="text-lg font-semibold text-blue-700">Total Repair Revenue</h3>
                        <p className="text-3xl font-bold text-blue-600">{showAmounts ? `₹${totalRepairRevenue}` : '***'}</p>
                    </div>

                    <h3 className="text-xl font-bold text-gray-700 mb-4 text-center">Repair History</h3>
                    {loading ? (
                        <p className="text-center text-gray-600">Loading repair records...</p>
                    ) : (
                        <GenericTable
                            data={repairs}
                            columns={truckRepairColumns}
                            onDelete={onDeleteRepair}
                            onEdit={setEditingRecord}
                            title="Truck Repair Records"
                            onBack={onBack}
                            showAmounts={showAmounts}
                            searchKeys={truckRepairSearchKeys}
                        />
                    )}
                </div>
            );
        }

        // --- Rent Collection Module ---
        function RentCollectionModule({ rents, loading, onDeleteRent, onSaveRent, onBack, showAmounts, editingRecord, setEditingRecord }) {
            const [propertyAddress, setPropertyAddress] = React.useState('');
            const [tenantName, setTenantName] = React.useState('');
            const [amount, setAmount] = React.useState('');
            const [month, setMonth] = React.useState(new Date().toLocaleString('default', { month: 'long', year: 'numeric' }));
            const [dateCollected, setDateCollected] = React.useState(new Date().toISOString().split('T')[0]);
            const [paymentMethod, setPaymentMethod] = React.useState('Cash');

            const paymentMethods = ['Cash', 'KB', 'PNB'];

            React.useEffect(() => {
                console.log("[RentCollectionModule] useEffect triggered. editingRecord:", editingRecord);
                if (editingRecord) {
                    setPropertyAddress(editingRecord.propertyAddress || '');
                    setTenantName(editingRecord.tenantName || '');
                    setAmount(String(editingRecord.amount || ''));
                    setMonth(editingRecord.month || new Date().toLocaleString('default', { month: 'long', year: 'numeric' }));
                    setDateCollected(editingRecord.dateCollected || new Date().toISOString().split('T')[0]);
                    setPaymentMethod(editingRecord.paymentMethod || 'Cash');
                } else {
                    setPropertyAddress('');
                    setTenantName('');
                    setAmount('');
                    setMonth(new Date().toLocaleString('default', { month: 'long', year: 'numeric' }));
                    setDateCollected(new Date().toISOString().split('T')[0]);
                    setPaymentMethod('Cash');
                }
            }, [editingRecord]);

            const handleSave = async (e) => {
                e.preventDefault();
                if (!propertyAddress.trim() || !tenantName.trim() || !amount || !month || !dateCollected || !paymentMethod) {
                    console.error('Validation Error: Please fill in all fields for Rent Collection.');
                    return;
                }
                let numAmount = parseFloat(amount);
                if (isNaN(numAmount) || numAmount <= 0) {
                    console.error('Validation Error: Please enter a valid positive number for the amount.');
                    return;
                }
                numAmount = parseFloat(numAmount.toFixed(2));

                const dataToSave = {
                    propertyAddress: propertyAddress.trim(),
                    tenantName: tenantName.trim(),
                    amount: numAmount,
                    month,
                    dateCollected,
                    paymentMethod,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    collectionName: 'rent_collections'
                };

                await onSaveRent(editingRecord ? { ...dataToSave, id: editingRecord.id } : dataToSave, 'rent_collections');
            };

            const totalRentCollected = rents.reduce((sum, r) => sum + r.amount, 0).toFixed(2);

            const rentCollectionColumns = [
                { key: 'dateCollected', header: 'Date', align: 'text-left' },
                { key: 'propertyAddress', header: 'Property', align: 'text-left' },
                { key: 'tenantName', header: 'Tenant', align: 'text-left' },
                { key: 'month', header: 'Month', align: 'text-left' },
                { key: 'amount', header: 'Amount', align: 'text-right', render: (value) => `₹${value.toFixed(2)}` },
                { key: 'paymentMethod', header: 'Method', align: 'text-left' },
            ];

            const rentSearchKeys = ['propertyAddress', 'tenantName', 'month', 'paymentMethod', 'dateCollected'];

            return (
                <div className="bg-white bg-opacity-90 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-5xl text-gray-800">
                    <button
                        onClick={onBack}
                        className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                    >
                        &larr; Back to Dashboard
                    </button>
                    <h2 className="text-3xl font-bold text-gray-800 mb-8 text-center drop-shadow">
                        🏠 Rent Collection Management
                    </h2>

                    <form onSubmit={handleSave} className="space-y-4 mb-8">
                        <div>
                            <label htmlFor="propertyAddress" className="block text-sm font-medium text-gray-700">Property Address</label>
                            <input type="text" id="propertyAddress" value={propertyAddress} onChange={(e) => setPropertyAddress(e.target.value)} placeholder="Apt 101, Main St" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="tenantName" className="block text-sm font-medium text-gray-700">Tenant Name</label>
                            <input type="text" id="tenantName" value={tenantName} onChange={(e) => setTenantName(e.target.value)} placeholder="Jane Doe" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="rentAmount" className="block text-sm font-medium text-gray-700">Amount</label>
                            <input type="number" id="rentAmount" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="e.g., 15000.00" step="0.01" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="rentMonth" className="block text-sm font-medium text-gray-700">Month</label>
                            <input type="text" id="rentMonth" value={month} onChange={(e) => setMonth(e.target.value)} placeholder="July 2025" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="dateCollected" className="block text-sm font-medium text-gray-700">Date Collected</label>
                            <input type="date" id="dateCollected" value={dateCollected} onChange={(e) => setDateCollected(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="rentPaymentMethod" className="block text-sm font-medium text-gray-700">Payment Method</label>
                            <select id="rentPaymentMethod" value={paymentMethod} onChange={(e) => setPaymentMethod(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900" required>
                                {paymentMethods.map(method => (
                                    <option key={method} value={method}>{method}</option>
                                ))}
                            </select>
                        </div>
                        <button type="submit" className="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                            {editingRecord ? 'Update Rent' : 'Add Rent Record'}
                        </button>
                        {editingRecord && (
                            <button
                                type="button"
                                onClick={() => setEditingRecord(null)}
                                className="w-full bg-gray-400 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                            >
                                Cancel Edit
                            </button>
                        )}
                    </form>

                    <div className="bg-blue-100 rounded-lg p-3 text-center mb-8">
                        <h3 className="text-lg font-semibold text-blue-700">Total Rent Collected</h3>
                        <p className="text-3xl font-bold text-blue-600">{showAmounts ? `₹${totalRentCollected}` : '***'}</p>
                    </div>

                    <h3 className="text-xl font-bold text-gray-700 mb-4 text-center">Rent Collection History</h3>
                    {loading ? (
                        <p className="text-center text-gray-600">Loading rent records...</p>
                    ) : (
                        <GenericTable
                            data={rents}
                            columns={rentCollectionColumns}
                            onDelete={onDeleteRent}
                            onEdit={setEditingRecord}
                            title="Rent Collection Records"
                            onBack={onBack}
                            showAmounts={showAmounts}
                            searchKeys={rentSearchKeys}
                        />
                    )}
                </div>
            );
        }

        // --- Money Lending Module ---
        function MoneyLendingModule({ loans, loading, onDeleteLoan, onSaveLoan, onBack, showAmounts, editingRecord, setEditingRecord }) {
            const [borrowerName, setBorrowerName] = React.useState('');
            const [amountLent, setAmountLent] = React.useState('');
            const [interestRate, setInterestRate] = React.useState('');
            const [loanDate, setLoanDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [dueDate, setDueDate] = React.useState('');
            const [amountReturned, setAmountReturned] = React.useState('');
            const [returnDate, setReturnDate] = React.useState('');
            const [status, setStatus] = React.useState('Outstanding');

            React.useEffect(() => {
                console.log("[MoneyLendingModule] useEffect triggered. editingRecord:", editingRecord);
                if (editingRecord) {
                    setBorrowerName(editingRecord.borrowerName || '');
                    setAmountLent(String(editingRecord.amountLent || ''));
                    setInterestRate(String(editingRecord.interestRate || ''));
                    setLoanDate(editingRecord.loanDate || new Date().toISOString().split('T')[0]);
                    setDueDate(editingRecord.dueDate || '');
                    setAmountReturned(String(editingRecord.amountReturned || ''));
                    setReturnDate(editingRecord.returnDate || '');
                    setStatus(editingRecord.status || 'Outstanding');
                } else {
                    setBorrowerName('');
                    setAmountLent('');
                    setInterestRate('');
                    setLoanDate(new Date().toISOString().split('T')[0]);
                    setDueDate('');
                    setAmountReturned('');
                    setReturnDate('');
                    setStatus('Outstanding');
                }
            }, [editingRecord]);

            const handleSave = async (e) => {
                e.preventDefault();
                if (!borrowerName.trim() || !amountLent || !loanDate || !dueDate) {
                    console.error('Validation Error: Please fill in required fields for Money Lending.');
                    return;
                }
                let numAmountLent = parseFloat(amountLent);
                if (isNaN(numAmountLent) || numAmountLent <= 0) {
                    console.error('Validation Error: Please enter a valid positive number for amount lent.');
                    return;
                }
                numAmountLent = parseFloat(numAmountLent.toFixed(2));

                let numInterestRate = interestRate ? parseFloat(interestRate) : 0;
                if (isNaN(numInterestRate) || numInterestRate < 0) {
                    console.error('Validation Error: Please enter a valid non-negative number for interest rate.');
                    return;
                }
                numInterestRate = parseFloat(numInterestRate.toFixed(2));

                let numAmountReturned = amountReturned ? parseFloat(amountReturned) : 0;
                if (isNaN(numAmountReturned) || numAmountReturned < 0) {
                    console.error('Validation Error: Please enter a valid non-negative number for amount returned.');
                    return;
                }
                numAmountReturned = parseFloat(numAmountReturned.toFixed(2));

                const loanData = {
                    borrowerName: borrowerName.trim(),
                    amountLent: numAmountLent,
                    interestRate: numInterestRate,
                    loanDate,
                    dueDate,
                    amountReturned: numAmountReturned,
                    returnDate: returnDate || null,
                    status,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    collectionName: 'money_lendings'
                };

                await onSaveLoan(editingRecord ? { ...loanData, id: editingRecord.id } : loanData, 'money_lendings');
            };

            const totalAmountLent = loans.reduce((sum, l) => sum + l.amountLent, 0).toFixed(2);
            const totalAmountReturned = loans.reduce((sum, l) => sum + l.amountReturned, 0).toFixed(2);
            const outstandingLoans = (parseFloat(totalAmountLent) - parseFloat(totalAmountReturned)).toFixed(2);

            const moneyLendingColumns = [
                { key: 'loanDate', header: 'Loan Date', align: 'text-left' },
                { key: 'borrowerName', header: 'Borrower', align: 'text-left' },
                { key: 'amountLent', header: 'Lent', align: 'text-right', render: (value) => `₹${value.toFixed(2)}` },
                { key: 'interestRate', header: 'Interest (%)', align: 'text-right', render: (value) => value ? `${value}%` : 'N/A' },
                { key: 'dueDate', header: 'Due Date', align: 'text-left' },
                { key: 'amountReturned', header: 'Returned', align: 'text-right', render: (value) => `₹${value.toFixed(2)}` },
                { key: 'returnDate', header: 'Return Date', align: 'text-left' },
                { key: 'status', header: 'Status', align: 'text-left', render: (value) => <span className={`font-semibold ${value === 'Outstanding' ? 'text-red-500' : value === 'Paid' ? 'text-green-500' : 'text-orange-500'}`}>{value}</span> },
            ];

            const moneyLendingSearchKeys = ['borrowerName', 'status', 'loanDate', 'dueDate'];

            return (
                <div className="bg-white bg-opacity-90 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-5xl text-gray-800">
                    <button
                        onClick={onBack}
                        className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                    >
                        &larr; Back to Dashboard
                    </button>
                    <h2 className="text-3xl font-bold text-gray-800 mb-8 text-center drop-shadow">
                        💸 Money Lending Management
                    </h2>

                    <form onSubmit={handleSave} className="space-y-4 mb-8">
                        <div>
                            <label htmlFor="borrowerName" className="block text-sm font-medium text-gray-700">Borrower Name</label>
                            <input type="text" id="borrowerName" value={borrowerName} onChange={(e) => setBorrowerName(e.target.value)} placeholder="Borrower's Name" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="amountLent" className="block text-sm font-medium text-gray-700">Amount Lent</label>
                            <input type="number" id="amountLent" value={amountLent} onChange={(e) => setAmountLent(e.target.value)} placeholder="e.g., 10000.00" step="0.01" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="interestRate" className="block text-sm font-medium text-gray-700">Interest Rate (%) (Optional)</label>
                            <input type="number" id="interestRate" value={interestRate} onChange={(e) => setInterestRate(e.target.value)} placeholder="e.g., 5" step="0.01" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" />
                        </div>
                        <div>
                            <label htmlFor="loanDate" className="block text-sm font-medium text-gray-700">Loan Date</label>
                            <input type="date" id="loanDate" value={loanDate} onChange={(e) => setLoanDate(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="dueDate" className="block text-sm font-medium text-gray-700">Due Date</label>
                            <input type="date" id="dueDate" value={dueDate} onChange={(e) => setDueDate(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" required />
                        </div>
                        <div>
                            <label htmlFor="amountReturned" className="block text-sm font-medium text-gray-700">Amount Returned (Optional)</label>
                            <input type="number" id="amountReturned" value={amountReturned} onChange={(e) => setAmountReturned(e.target.value)} placeholder="e.g., 5000.00" step="0.01" className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" />
                        </div>
                        <div>
                            <label htmlFor="returnDate" className="block text-sm font-medium text-gray-700">Return Date (Optional)</label>
                            <input type="date" id="returnDate" value={returnDate} onChange={(e) => setReturnDate(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500" />
                        </div>
                        <div>
                            <label htmlFor="status" className="block text-sm font-medium text-gray-700">Status</label>
                            <select id="status" value={status} onChange={(e) => setStatus(e.target.value)} className="mt-1 block w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900" required>
                                <option value="Outstanding">Outstanding</option>
                                <option value="Paid">Paid</option>
                                <option value="Partially Paid">Partially Paid</option>
                            </select>
                        </div>
                        <button type="submit" className="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                            {editingRecord ? 'Update Loan' : 'Add Loan Record'}
                        </button>
                        {editingRecord && (
                            <button
                                type="button"
                                onClick={() => setEditingRecord(null)}
                                className="w-full bg-gray-400 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                            >
                                Cancel Edit
                            </button>
                        )}
                    </form>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-8">
                        <div className="bg-blue-100 rounded-lg p-3">
                            <h3 className="text-lg font-semibold text-blue-700">Total Lent</h3>
                            <p className="text-2xl font-bold text-blue-600">{showAmounts ? `₹${totalAmountLent}` : '***'}</p>
                        </div>
                        <div className="bg-green-100 rounded-lg p-3">
                            <h3 className="text-lg font-semibold text-green-700">Total Returned</h3>
                            <p className="text-2xl font-bold text-green-600">{showAmounts ? `₹${totalAmountReturned}` : '***'}</p>
                        </div>
                        <div className={`rounded-lg p-3 ${parseFloat(outstandingLoans) > 0 ? 'bg-red-100' : 'bg-green-100'}`}>
                            <h3 className="text-lg font-semibold text-gray-700">Outstanding Loans</h3>
                            <p className={`text-2xl font-bold ${parseFloat(outstandingLoans) > 0 ? 'text-red-600' : 'text-green-600'}`}>{showAmounts ? `₹${outstandingLoans}` : '***'}</p>
                        </div>
                    </div>

                    <h3 className="text-xl font-bold text-gray-700 mb-4 text-center">Lending History</h3>
                    {loading ? (
                        <p className="text-center text-gray-600">Loading loan records...</p>
                    ) : (
                        <GenericTable
                            data={loans}
                            columns={moneyLendingColumns}
                            onDelete={onDeleteLoan}
                            onEdit={setEditingRecord}
                            title="Money Lending Records"
                            onBack={onBack}
                            showAmounts={showAmounts}
                            searchKeys={moneyLendingSearchKeys}
                        />
                    )}
                </div>
            );
        }

        // --- All Transactions History Module ---
        function AllTransactionsHistoryModule({ allData, onDeleteRecord, onEditRecord, onBack, showAmounts, initialFilterMethod }) {
            const [searchTerm, setSearchTerm] = React.useState('');
            const [filterMethod, setFilterMethod] = React.useState(initialFilterMethod || 'All'); // Use initialFilterMethod
            const [filterSource, setFilterSource] = React.useState('All');

            const paymentMethods = ['All', 'Cash', 'KB', 'PNB'];
            const sources = ['All', 'Personal', 'Truck Repair', 'Rent Collection', 'Money Lending'];

            // Update filterMethod if initialFilterMethod changes (e.g., from main page navigation)
            React.useEffect(() => {
                if (initialFilterMethod) {
                    setFilterMethod(initialFilterMethod);
                }
            }, [initialFilterMethod]);

            // Standardize data for display in a single table
            const standardizedData = React.useMemo(() => {
                const combined = [];
                allData.forEach(collectionData => {
                    collectionData.forEach(item => {
                        let typeDisplay = '';
                        let amountValue = 0;
                        let dateDisplay = '';
                        let descriptionDisplay = '';
                        let paymentMethodDisplay = item.paymentMethod || 'N/A';
                        let sourceDisplay = '';

                        switch (item.collectionName) {
                            case 'personal_transactions':
                                typeDisplay = item.type === 'income' ? 'Income' : 'Expense';
                                amountValue = item.amount;
                                dateDisplay = item.date;
                                descriptionDisplay = item.description;
                                sourceDisplay = 'Personal';
                                combined.push({
                                    ...item, // Keep original item for edit
                                    typeDisplay, amountValue, dateDisplay, descriptionDisplay, paymentMethod: paymentMethodDisplay, sourceDisplay,
                                    uniqueId: item.id + '-personal' // Unique ID for this row in combined view
                                });
                                break;
                            case 'truck_repairs':
                                typeDisplay = 'Income (Repair)';
                                amountValue = item.cost;
                                dateDisplay = item.date;
                                descriptionDisplay = `Repair: ${item.repairDescription} (Vehicle: ${item.vehicleId}, Customer: ${item.customerName})`;
                                sourceDisplay = 'Truck Repair';
                                combined.push({
                                    ...item,
                                    typeDisplay, amountValue, dateDisplay, descriptionDisplay, paymentMethod: paymentMethodDisplay, sourceDisplay,
                                    uniqueId: item.id + '-truck'
                                });
                                break;
                            case 'rent_collections':
                                typeDisplay = 'Income (Rent)';
                                amountValue = item.amount;
                                dateDisplay = item.dateCollected;
                                descriptionDisplay = `Rent: ${item.month} (Property: ${item.propertyAddress}, Tenant: ${item.tenantName})`;
                                sourceDisplay = 'Rent Collection';
                                combined.push({
                                    ...item,
                                    typeDisplay, amountValue, dateDisplay, descriptionDisplay, paymentMethod: paymentMethodDisplay, sourceDisplay,
                                    uniqueId: item.id + '-rent'
                                });
                                break;
                            case 'money_lendings':
                                // Money lending has both lent (expense) and returned (income)
                                if (item.amountLent > 0) {
                                    combined.push({
                                        ...item, // Keep original item for edit
                                        id: item.id, // Use original ID for editing
                                        typeDisplay: 'Lent',
                                        amountValue: item.amountLent,
                                        dateDisplay: item.loanDate,
                                        descriptionDisplay: `Loan to ${item.borrowerName} (Interest: ${item.interestRate || 'N/A'}%)`,
                                        sourceDisplay: 'Money Lending',
                                        uniqueId: item.id + '-lent'
                                    });
                                }
                                if (item.amountReturned > 0) {
                                    combined.push({
                                        ...item, // Keep original item for edit
                                        id: item.id, // Use original ID for editing
                                        typeDisplay: 'Returned',
                                        amountValue: item.amountReturned,
                                        dateDisplay: item.returnDate || item.loanDate, // Use returnDate if available, else loanDate
                                        descriptionDisplay: `Return from ${item.borrowerName}`,
                                        sourceDisplay: 'Money Lending',
                                        uniqueId: item.id + '-returned'
                                    });
                                }
                                break;
                        }
                    });
                });
                return combined.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)); // Sort by newest first
            }, [allData]); // Recalculate only when allData changes

            const filteredAndSearchedData = standardizedData.filter(item => {
                const matchesSearch = searchTerm.trim() === '' ||
                    String(item.descriptionDisplay).toLowerCase().includes(searchTerm.toLowerCase()) ||
                    String(item.dateDisplay).toLowerCase().includes(searchTerm.toLowerCase()) ||
                    String(item.paymentMethod).toLowerCase().includes(searchTerm.toLowerCase()) ||
                    String(item.typeDisplay).toLowerCase().includes(searchTerm.toLowerCase()) ||
                    String(item.sourceDisplay).toLowerCase().includes(searchTerm.toLowerCase());

                const matchesMethod = filterMethod === 'All' || item.paymentMethod === filterMethod;
                const matchesSource = filterSource === 'All' || item.sourceDisplay === filterSource;

                return matchesSearch && matchesMethod && matchesSource;
            });


            const allTransactionsColumns = [
                { key: 'dateDisplay', header: 'Date', align: 'text-left' },
                { key: 'descriptionDisplay', header: 'Description', align: 'text-left' },
                { key: 'typeDisplay', header: 'Type', align: 'text-left', render: (value) => {
                    let colorClass = 'text-gray-700';
                    if (value.includes('Income') || value.includes('Returned')) colorClass = 'text-green-500';
                    if (value.includes('Expense') || value.includes('Lent')) colorClass = 'text-red-500';
                    return <span className={`font-semibold ${colorClass}`}>{value}</span>;
                }},
                { key: 'amountValue', header: 'Amount', align: 'text-right', render: (value) => `₹${value.toFixed(2)}` },
                { key: 'paymentMethod', header: 'Method', align: 'text-left' },
                { key: 'sourceDisplay', header: 'Source', align: 'text-left' },
            ];

            // Calculate combined balances for this page
            const getCombinedBalanceByMethodForPage = (methodFilter) => {
                let income = 0;
                let expense = 0;

                standardizedData.forEach(item => {
                    if (item.paymentMethod === methodFilter) {
                        if (item.typeDisplay.includes('Income') || item.typeDisplay.includes('Returned')) {
                            income += item.amountValue;
                        } else if (item.typeDisplay.includes('Expense') || item.typeDisplay.includes('Lent')) {
                            expense += item.amountValue;
                        }
                    }
                });
                return (income - expense).toFixed(2);
            };


            return (
                <div className="bg-white bg-opacity-90 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-6xl text-gray-800">
                    <button
                        onClick={onBack}
                        className="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                    >
                        &larr; Back to Dashboard
                    </button>
                    <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center drop-shadow">
                        All Transactions History
                    </h2>

                    {/* Combined Balances by Payment Method (on All Transactions History Page) */}
                    <h3 className="text-2xl font-bold text-gray-700 mb-4 text-center">Combined Balances by Method</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                        {paymentMethods.filter(m => m !== 'All').map(method => {
                            const combinedBalance = getCombinedBalanceByMethodForPage(method);
                            return (
                                <div key={method} className={`rounded-lg p-3 ${parseFloat(combinedBalance) >= 0 ? 'bg-green-100' : 'bg-red-100'} shadow-sm`}>
                                    <h4 className="text-lg font-semibold text-gray-700">{method} Balance</h4>
                                    <p className={`text-2xl font-bold ${parseFloat(combinedBalance) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {showAmounts ? `₹${combinedBalance}` : '***'}
                                    </p>
                                </div>
                            );
                        })}
                    </div>
                    <div className="flex justify-center mb-6">
                        {/* Toggle amounts button */}
                        <button
                            onClick={() => onEditRecord({ type: 'toggle_amounts' })} // Special type to signal toggle
                            className="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                            aria-label={showAmounts ? 'Hide Amounts' : 'Show Amounts'}
                        >
                            {showAmounts ? 'Hide Amounts' : 'Show Amounts'}
                        </button>
                    </div>


                    <div className="flex flex-col sm:flex-row gap-4 mb-6">
                        <input
                            type="text"
                            placeholder="Search all records..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="flex-grow px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900 placeholder-gray-500"
                        />
                        <select
                            value={filterMethod}
                            onChange={(e) => setFilterMethod(e.target.value)}
                            className="px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900"
                        >
                            {paymentMethods.map(method => (
                                <option key={method} value={method}>{method === 'All' ? 'All Methods' : method}</option>
                            ))}
                        </select>
                        <select
                            value={filterSource}
                            onChange={(e) => setFilterSource(e.target.value)}
                            className="px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-purple-400 focus:ring focus:ring-purple-400 focus:ring-opacity-50 text-gray-900"
                        >
                            {sources.map(source => (
                                <option key={source} value={source}>{source === 'All' ? 'All Sources' : source}</option>
                            ))}
                        </select>
                    </div>

                    {filteredAndSearchedData.length === 0 ? (
                        <p className="text-center text-gray-600">No transactions matching your criteria.</p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full bg-gray-100 rounded-lg overflow-hidden border border-gray-300">
                                <thead className="bg-gray-200 text-left text-gray-700 uppercase text-sm leading-normal">
                                    <tr>
                                        {allTransactionsColumns.map(col => (
                                            <th key={col.key} className={`py-3 px-4 ${col.align || 'text-left'}`}>
                                                {col.header}
                                            </th>
                                        ))}
                                        <th className="py-3 px-4 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="text-gray-700 text-sm font-light">
                                    {filteredAndSearchedData.map((item) => (
                                        <tr key={item.uniqueId} className="border-b border-gray-300 hover:bg-gray-200">
                                            {allTransactionsColumns.map(col => (
                                                <td key={col.key} className={`py-3 px-4 ${col.align || 'text-left'}`}>
                                                    {col.key.includes('amount') || col.key.includes('cost') || col.key.includes('Lent') || col.key.includes('Returned') ?
                                                        (showAmounts ? (col.render ? col.render(item[col.key], item) : `₹${item[col.key].toFixed(2)}`) : '***')
                                                        : (col.render ? col.render(item[col.key], item) : item[col.key])
                                                    }
                                                </td>
                                            ))}
                                            <td className="py-3 px-4 text-center whitespace-nowrap">
                                                <button
                                                    onClick={() => onEditRecord(item)} // Calls central handler
                                                    className="text-blue-500 hover:text-blue-700 transition duration-200 mr-2"
                                                    aria-label={`Edit record ${item.id}`}
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                    </svg>
                                                </button>
                                                <button
                                                    onClick={() => onDeleteRecord(item.id, item.collectionName)}
                                                    className="text-red-500 hover:text-red-700 transition duration-200"
                                                    aria-label={`Delete record ${item.id}`}
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }


        // --- Main App Component ---
        function App() {
            console.log("App component started rendering.");

            // State to manage current view and editing
            const [currentView, setCurrentView] = React.useState('main');
            const [showAmounts, setShowAmounts] = React.useState(true);
            const [editingRecord, setEditingRecord] = React.useState(null); // Stores the record being edited
            const [editingCollection, setEditingCollection] = React.useState(null); // Stores the collection of the record being edited
            const [returnToViewAfterSave, setReturnToViewAfterSave] = React.useState('main'); // New state for navigation after save
            const [initialFilterMethodForHistory, setInitialFilterMethodForHistory] = React.useState(null); // New state for pre-filtering history

            // States for data from each Firestore collection
            const [personalTransactions, setPersonalTransactions] = React.useState([]);
            const [truckRepairs, setTruckRepairs] = React.useState([]);
            const [rentCollections, setRentCollections] = React.useState([]);
            const [moneyLendings, setMoneyLendings] = React.useState([]);

            // Loading states for each collection
            const [loadingPersonal, setLoadingPersonal] = React.useState(true);
            const [loadingTrucks, setLoadingTrucks] = React.useState(true);
            const [loadingRents, setLoadingRents] = React.useState(true);
            const [loadingLoans, setLoadingLoans] = React.useState(true);

            // Fetch data for Personal Transactions
            React.useEffect(() => {
                const q = db.collection("personal_transactions").orderBy("timestamp", "desc");
                const unsubscribe = q.onSnapshot((querySnapshot) => {
                    const fetched = [];
                    querySnapshot.forEach((doc) => fetched.push({ id: doc.id, ...doc.data(), collectionName: 'personal_transactions' }));
                    setPersonalTransactions(fetched);
                    setLoadingPersonal(false);
                }, (error) => { console.error("Error fetching personal transactions: ", error); setLoadingPersonal(false); });
                return () => unsubscribe();
            }, []);

            // Fetch data for Truck Repairs
            React.useEffect(() => {
                const q = db.collection("truck_repairs").orderBy("timestamp", "desc");
                const unsubscribe = q.onSnapshot((querySnapshot) => {
                    const fetched = [];
                    querySnapshot.forEach((doc) => fetched.push({ id: doc.id, ...doc.data(), collectionName: 'truck_repairs' }));
                    setTruckRepairs(fetched);
                    setLoadingTrucks(false);
                }, (error) => { console.error("Error fetching truck repairs: ", error); setLoadingTrucks(false); });
                return () => unsubscribe();
            }, []);

            // Fetch data for Rent Collections
            React.useEffect(() => {
                const q = db.collection("rent_collections").orderBy("timestamp", "desc");
                const unsubscribe = q.onSnapshot((querySnapshot) => {
                    const fetched = [];
                    querySnapshot.forEach((doc) => fetched.push({ id: doc.id, ...doc.data(), collectionName: 'rent_collections' }));
                    setRentCollections(fetched);
                    setLoadingRents(false);
                }, (error) => { console.error("Error fetching rent collections: ", error); setLoadingRents(false); });
                return () => unsubscribe();
            }, []);

            // Fetch data for Money Lendings
            React.useEffect(() => {
                const q = db.collection("money_lendings").orderBy("timestamp", "desc");
                const unsubscribe = q.onSnapshot((querySnapshot) => {
                    const fetched = [];
                    querySnapshot.forEach((doc) => fetched.push({ id: doc.id, ...doc.data(), collectionName: 'money_lendings' }));
                    setMoneyLendings(fetched);
                    setLoadingLoans(false);
                }, (error) => { console.error("Error fetching money lendings: ", error); setLoadingLoans(false); });
                return () => unsubscribe();
            }, []);

            // Generic save function for all modules (Add or Update)
            const handleSaveRecord = async (data, collectionName) => {
                try {
                    if (data.id) { // If data has an ID, it's an update
                        // Create a copy of data without the 'id' and 'collectionName' for Firestore update
                        const { id, collectionName: _, ...dataToUpdate } = data;
                        await db.collection(collectionName).doc(id).update(dataToUpdate);
                        console.log(`Record updated successfully in ${collectionName}.`);
                    } else { // Otherwise, it's a new record
                        // Create a copy of data without 'collectionName' for Firestore add
                        const { collectionName: _, ...dataToAdd } = data;
                        await db.collection(collectionName).add(dataToAdd);
                        console.log(`Record added successfully to ${collectionName}.`);
                    }
                    setEditingRecord(null); // Clear editing state
                    setEditingCollection(null); // Clear editing collection
                    setCurrentView(returnToViewAfterSave); // Go back to the view from which edit was initiated
                    setReturnToViewAfterSave('main'); // Reset for next edit
                    setInitialFilterMethodForHistory(null); // Clear any pending filter
                } catch (e) {
                    console.error(`Error saving document to ${collectionName}: `, e);
                    console.error(`Error saving record to ${collectionName}. Check console for details.`);
                }
            };

            // Generic delete function for all modules
            const handleDeleteRecord = async (id, collectionName) => {
                console.log(`Attempting to delete record ${id} from ${collectionName}.`);
                if (window.confirm(`Are you sure you want to delete this record from ${collectionName}?`)) {
                    try {
                        await db.collection(collectionName).doc(id).delete();
                        console.log(`Record deleted successfully from ${collectionName}.`);
                    } catch (e) {
                        console.error(`Error deleting document from ${collectionName}: `, e);
                        console.error(`Error deleting record from ${collectionName}. Check console for details.`);
                    }
                }
            };

            // Handle edit button click from GenericTable and also for the toggle amounts button
            const handleEditRecordClick = (record) => {
                console.log("Edit button clicked for record:", record);
                if (record.type === 'toggle_amounts') { // Special case for toggle button in AllTransactionsHistoryModule
                    setShowAmounts(prev => !prev);
                    return;
                }
                setEditingRecord(record);
                setEditingCollection(record.collectionName); // Store which collection this record belongs to
                setReturnToViewAfterSave(currentView); // Store current view to return to after save
                setInitialFilterMethodForHistory(null); // Clear any initial filter when starting an edit

                // Navigate to the correct module view based on the collection
                if (record.collectionName === 'personal_transactions') setCurrentView('personal_history');
                else if (record.collectionName === 'truck_repairs') setCurrentView('truck_repair');
                else if (record.collectionName === 'rent_collections') setCurrentView('rent_collection');
                else if (record.collectionName === 'money_lendings') setCurrentView('money_lending');
            };

            // New function to navigate to All Transactions History with a filter
            const handleViewMethodTransactions = (method) => {
                setInitialFilterMethodForHistory(method);
                setCurrentView('all_transactions');
                setEditingRecord(null); // Clear any editing state
                setEditingCollection(null);
                setReturnToViewAfterSave('all_transactions'); // Ensure return to history page
            };


            // New function to calculate combined balances across all modules for the main dashboard
            const getCombinedBalanceByMethod = (methodFilter) => {
                let income = 0;
                let expense = 0;

                // 1. Personal Transactions
                personalTransactions.forEach(t => {
                    if (t.paymentMethod === methodFilter) {
                        if (t.type === 'income') {
                            income += t.amount;
                        } else {
                            expense += t.amount;
                        }
                    }
                });

                // 2. Truck Repairs (Income)
                truckRepairs.forEach(r => {
                    if (r.paymentMethod === methodFilter) {
                        income += r.cost; // Repair cost is income for the business
                    }
                });

                // 3. Rent Collections (Income)
                rentCollections.forEach(r => {
                    if (r.paymentMethod === methodFilter) {
                        income += r.amount; // Rent collected is income
                    }
                });

                // 4. Money Lending (Lent is Expense, Returned is Income)
                moneyLendings.forEach(l => {
                    // Assuming paymentMethod applies to both lent and returned
                    // If a loan is partially paid, we only consider the returned amount as inflow
                    // and the outstanding as part of the expense (lent).
                    if (l.paymentMethod === methodFilter) {
                        expense += l.amountLent; // Amount lent is an outflow (expense from your capital)
                        income += l.amountReturned; // Amount returned is an inflow (income back to your capital)
                    }
                });

                return (income - expense).toFixed(2);
            };

            const paymentMethods = ['Cash', 'KB', 'PNB'];
            const today = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });


            return (
                <div className="min-h-screen bg-gray-100 p-4 flex flex-col items-center"> {/* Light background */}
                    {currentView === 'main' && (
                        <div className="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-2xl text-gray-800">
                            <h1 className="text-3xl md:text-4xl font-extrabold text-center text-gray-800 mb-2 drop-shadow-lg">
                                📊 Runnjit Singh's Financial Dashboard
                            </h1>
                            <p className="text-center text-gray-600 mb-6">{today}</p>

                            {/* Combined Balances by Payment Method (on Main Dashboard) */}
                            <h2 className="text-2xl font-bold text-gray-700 mb-4 text-center">Combined Balances by Method</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-4">
                                {paymentMethods.map(method => {
                                    const combinedBalance = getCombinedBalanceByMethod(method);
                                    return (
                                        <div key={method} className={`rounded-lg p-3 ${parseFloat(combinedBalance) >= 0 ? 'bg-green-100' : 'bg-red-100'} shadow-sm flex flex-col items-center justify-between`}>
                                            <h3 className="text-lg font-semibold text-gray-700">{method} Balance</h3>
                                            <p className={`text-2xl font-bold ${parseFloat(combinedBalance) >= 0 ? 'text-green-600' : 'text-red-600'} mb-2`}>
                                                {showAmounts ? `₹${combinedBalance}` : '***'}
                                            </p>
                                            <button
                                                onClick={() => handleViewMethodTransactions(method)}
                                                className="bg-blue-500 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-sm"
                                            >
                                                View Transactions
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                            <div className="flex justify-center mb-6">
                                {/* Toggle amounts button */}
                                <button
                                    onClick={() => setShowAmounts(!showAmounts)}
                                    className="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                                    aria-label={showAmounts ? 'Hide Amounts' : 'Show Amounts'}
                                >
                                    {showAmounts ? 'Hide Amounts' : 'Show Amounts'}
                                </button>
                            </div>


                            <h2 className="text-2xl font-bold text-gray-700 mb-6 text-center">Business Modules</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div className="bg-purple-50 rounded-lg p-4 text-center shadow-md">
                                    <h3 className="text-xl font-semibold text-purple-700 mb-3">Personal Transactions</h3>
                                    <p className="text-gray-600 mb-4">Manage daily income and expenses.</p>
                                    <button
                                        onClick={() => { setCurrentView('personal_history'); setEditingRecord(null); setEditingCollection(null); setReturnToViewAfterSave('personal_history'); }}
                                        className="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                                    >
                                        Go to Personal
                                    </button>
                                </div>
                                <div className="bg-green-50 rounded-lg p-4 text-center shadow-md">
                                    <h3 className="text-xl font-semibold text-green-700 mb-3">Truck Repairing</h3>
                                    <p className="text-gray-600 mb-4">Track vehicle repair records.</p>
                                    <button
                                        onClick={() => { setCurrentView('truck_repair'); setEditingRecord(null); setEditingCollection(null); setReturnToViewAfterSave('truck_repair'); }}
                                        className="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                                    >
                                        Go to Truck Repair
                                    </button>
                                </div>
                                <div className="bg-yellow-50 rounded-lg p-4 text-center shadow-md">
                                    <h3 className="text-xl font-semibold text-yellow-700 mb-3">Rent Collection</h3>
                                    <p className="text-gray-600 mb-4">Record monthly rent payments.</p>
                                    <button
                                        onClick={() => { setCurrentView('rent_collection'); setEditingRecord(null); setEditingCollection(null); setReturnToViewAfterSave('rent_collection'); }}
                                        className="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                                    >
                                        Go to Rent
                                    </button>
                                </div>
                                <div className="bg-red-50 rounded-lg p-4 text-center shadow-md">
                                    <h3 className="text-xl font-semibold text-red-700 mb-3">Money Lending</h3>
                                    <p className="text-gray-600 mb-4">Manage loans given and returned.</p>
                                    <button
                                        onClick={() => { setCurrentView('money_lending'); setEditingRecord(null); setEditingCollection(null); setReturnToViewAfterSave('money_lending'); }}
                                        className="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                                    >
                                        Go to Money Lending
                                    </button>
                                </div>
                            </div>
                            <div className="mt-8 text-center">
                                <button
                                    onClick={() => { setCurrentView('all_transactions'); setEditingRecord(null); setEditingCollection(null); setReturnToViewAfterSave('all_transactions'); setInitialFilterMethodForHistory(null); }}
                                    className="bg-blue-600 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
                                >
                                    View All Transactions History
                                </button>
                            </div>
                        </div>
                    )}

                    {currentView === 'personal_history' && (
                        <PersonalTransactionsModule
                            transactions={personalTransactions}
                            loading={loadingPersonal}
                            onDeleteTransaction={handleDeleteRecord}
                            onSaveTransaction={handleSaveRecord}
                            onBack={() => { setCurrentView('main'); setEditingRecord(null); setEditingCollection(null); setReturnToViewAfterSave('main'); }}
                            showAmounts={showAmounts}
                            editingRecord={editingRecord && editingCollection === 'personal_transactions' ? editingRecord : null}
                            setEditingRecord={handleEditRecordClick}
                        />
                    )}

                    {currentView === 'truck_repair' && (
                        <TruckRepairModule
                            repairs={truckRepairs}
                            loading={loadingTrucks}
                            onDeleteRepair={handleDeleteRecord}
                            onSaveRepair={handleSaveRecord}
                            onBack={() => { setCurrentView('main'); setEditingRecord(null); setEditingCollection(null); setReturnToViewAfterSave('main'); }}
                            showAmounts={showAmounts}
                            editingRecord={editingRecord && editingCollection === 'truck_repairs' ? editingRecord : null}
                            setEditingRecord={handleEditRecordClick}
                        />
                    )}

                    {currentView === 'rent_collection' && (
                        <RentCollectionModule
                            rents={rentCollections}
                            loading={loadingRents}
                            onDeleteRent={handleDeleteRecord}
                            onSaveRent={handleSaveRecord}
                            onBack={() => { setCurrentView('main'); setEditingRecord(null); setEditingCollection(null); setReturnToViewAfterSave('main'); }}
                            showAmounts={showAmounts}
                            editingRecord={editingRecord && editingCollection === 'rent_collections' ? editingRecord : null}
                            setEditingRecord={handleEditRecordClick}
                        />
                    )}

                    {currentView === 'money_lending' && (
                        <MoneyLendingModule
                            loans={moneyLendings}
                            loading={loadingLoans}
                            onDeleteLoan={handleDeleteRecord}
                            onSaveLoan={handleSaveRecord}
                            onBack={() => { setCurrentView('main'); setEditingRecord(null); setEditingCollection(null); setReturnToViewAfterSave('main'); }}
                            showAmounts={showAmounts}
                            editingRecord={editingRecord && editingCollection === 'money_lendings' ? editingRecord : null}
                            setEditingRecord={handleEditRecordClick}
                        />
                    )}

                    {currentView === 'all_transactions' && (
                        <AllTransactionsHistoryModule
                            allData={[personalTransactions, truckRepairs, rentCollections, moneyLendings]}
                            onDeleteRecord={handleDeleteRecord}
                            onEditRecord={handleEditRecordClick}
                            onBack={() => { setCurrentView('main'); setEditingRecord(null); setEditingCollection(null); setReturnToViewAfterSave('main'); setInitialFilterMethodForHistory(null); }}
                            showAmounts={showAmounts}
                            initialFilterMethod={initialFilterMethodForHistory}
                        />
                    )}
                </div>
            );
        }

        // Render the React App component into the root div
        const container = document.getElementById('root');
        console.log("Root container found:", container);
        if (container) {
            const root = ReactDOM.createRoot(container);
            root.render(React.createElement(App));
            console.log("React App rendered.");
        } else {
            console.error("Error: Root container with ID 'root' not found in the HTML.");
        }
    </script>
</head>
<body class="m-0 p-0">
    <div id="root"></div>
</body>
</html>